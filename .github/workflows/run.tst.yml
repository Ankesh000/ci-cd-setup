# This is a basic workflow to help you get started with Actions

name: CI workflow

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
run-linter-and-tests:
  runs-on: ubuntu-latest

  # Steps represent a sequence of tasks that will be executed as part of the job
  steps:
    - name: Checkout code
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: npm i

    - name: Lint code
      run: npm run lint

    - name: Run tests
      run: npm test

    - name: Run tests with coverage
      run: |
        npm run test -- --coverage || echo "âš ï¸ Tests or coverage generation failed, continuing anyway..."

    - name: Ensure coverage summary exists (fallback)
      run: |
        # Detect possible coverage folders
        if [ -d "coverage" ]; then
          echo "âœ… Found coverage folder."
        elif [ -d ".vitest/coverage" ]; then
          echo "ðŸ“‚ Found .vitest/coverage, moving it to ./coverage"
          mv .vitest/coverage coverage
        else
          echo "âš ï¸ No coverage folder found. Creating a dummy one."
          mkdir -p coverage
        fi

        # Ensure coverage-summary.json exists
        if [ ! -f "coverage/coverage-summary.json" ]; then
          echo "âš ï¸ coverage-summary.json not found, creating dummy file."
          echo '{"total": {"lines": {"pct": 0}, "statements": {"pct": 0}, "functions": {"pct": 0}, "branches": {"pct": 0}}}' > coverage/coverage-summary.json
        fi

        # Ensure coverage-final.json exists
        if [ ! -f "coverage/coverage-final.json" ]; then
          echo "âš ï¸ coverage-final.json not found, creating dummy file."
          echo '{}' > coverage/coverage-final.json
        fi

    - name: Vitest Coverage Report Action
      uses: davelosert/vitest-coverage-report-action@v2
      with:
        json-summary-path: coverage/coverage-summary.json
        json-final-path: coverage/coverage-final.json
        file-coverage-mode: changes
        comment-on: pr
